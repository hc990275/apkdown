import sys
import os
import traceback
import json
import requests
import webbrowser
import hashlib
import re

# === 1. å…¨å±€å´©æºƒä¿æŠ¤ ===
def handle_exception(exc_type, exc_value, exc_traceback):
    if issubclass(exc_type, KeyboardInterrupt):
        sys.__excepthook__(exc_type, exc_value, exc_traceback)
        return
    err_msg = "".join(traceback.format_exception(exc_type, exc_value, exc_traceback))
    try:
        with open("é”™è¯¯æ—¥å¿—.txt", "w", encoding="utf-8") as f:
            f.write(err_msg)
    except:
        pass

sys.excepthook = handle_exception

# === 2. å¯¼å…¥åº“ ===
try:
    from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                                 QHBoxLayout, QLabel, QPushButton, QScrollArea, 
                                 QFrame, QMessageBox, QGridLayout, QTextEdit, QDialog)
    from PyQt6.QtCore import Qt, QThread, pyqtSignal, QUrl
    from PyQt6.QtGui import QPixmap, QIcon, QFont, QCursor
    from PyQt6.QtNetwork import QNetworkAccessManager, QNetworkRequest, QNetworkReply
except ImportError as e:
    print(f"ç¼ºå°‘åº“: {e}")
    sys.exit(1)

# === 3. æ ¸å¿ƒé…ç½® ===
TARGET_URL = "https://github.com/lystv/fmapp/blob/app/yysd-zl.json"
VERSION_INFO_URL = "https://github.com/lystv/fmapp/blob/app/ok.txt"

HISTORY_FILE = "version_history.json"
LAST_OK_FILE = "last_ok_log.txt"  # æ–°å¢žï¼šç”¨äºŽå­˜å‚¨ä¸Šä¸€æ¬¡çš„ok.txtå†…å®¹
FONGMI_ICON_URL = "https://raw.githubusercontent.com/lystv/fmapp/img/log/ys.jpg"
CACHE_DIR = "icon_cache"

# === 4. å·¥å…·å‡½æ•° ===
def ensure_cache_dir():
    if not os.path.exists(CACHE_DIR):
        os.makedirs(CACHE_DIR)

def get_cache_path(url):
    if not url: return None
    hash_name = hashlib.md5(url.encode('utf-8')).hexdigest()
    return os.path.join(CACHE_DIR, hash_name + ".png")

def format_github_raw_url(url):
    if "github.com" in url and "/blob/" in url:
        return url.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/")
    return url

# === 5. æ ·å¼è¡¨ ===
STYLESHEET = """
QMainWindow { background-color: #f2f3f5; }

QFrame#TopBar {
    background-color: white;
    border-bottom: 1px solid #e5e5e5;
}

QLabel#GroupHeader {
    font-family: "Microsoft YaHei";
    font-size: 16px; 
    font-weight: 900; 
    color: #1f1f1f;
    padding-left: 8px;
    border-left: 5px solid #0078d4;
    margin-top: 20px;
    margin-bottom: 10px;
}

QFrame#GridCard {
    background-color: white; 
    border: 1px solid #e0e0e0;
    border-radius: 6px;
}
QFrame#GridCard:hover {
    border: 1px solid #0078d4;
    background-color: #ffffff;
}

QFrame#GridCard[is_new="true"] {
    border: 2px solid #d93025;
    background-color: #fff8f8;
}

QLabel#GridTitle { font-size: 13px; font-weight: bold; color: #333; }
QLabel#GridVer { font-size: 11px; color: #999; }
QLabel#GridVerNew { font-size: 11px; color: #d93025; font-weight: bold; }

QLabel#TimeLabel {
    font-size: 12px;
    color: #888;
    margin-right: 10px;
    font-family: "Consolas", "Microsoft YaHei";
}
"""

# === æ–°å¢žï¼šæ˜¾ç¤ºæ›´æ–°æ—¥å¿—çš„å¼¹çª— ===
class LogDialog(QDialog):
    def __init__(self, log_text, parent=None):
        super().__init__(parent)
        self.setWindowTitle("æœ¬æ¬¡ç»´æŠ¤æ›´æ–°è¯¦æƒ…")
        self.resize(500, 400)
        layout = QVBoxLayout(self)
        
        lbl = QLabel("æ£€æµ‹åˆ°ä»¥ä¸‹å˜åŠ¨ï¼š")
        lbl.setStyleSheet("font-weight: bold; font-size: 14px;")
        layout.addWidget(lbl)
        
        self.text_area = QTextEdit()
        self.text_area.setReadOnly(True)
        self.text_area.setText(log_text)
        self.text_area.setStyleSheet("font-family: Consolas, Microsoft YaHei; font-size: 12px; line-height: 1.5;")
        layout.addWidget(self.text_area)
        
        btn = QPushButton("å…³é—­")
        btn.clicked.connect(self.accept)
        layout.addWidget(btn)

class VersionManager:
    def __init__(self):
        self.history = {}
        self.load()
    
    def load(self):
        if os.path.exists(HISTORY_FILE):
            try:
                with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
                    self.history = json.load(f)
            except: self.history = {}

    def save(self):
        with open(HISTORY_FILE, 'w', encoding='utf-8') as f:
            json.dump(self.history, f, ensure_ascii=False, indent=4)

    # ä»…æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç‰ˆæœ¬ï¼Œä¸æ›´æ–°çŠ¶æ€ï¼ˆç”¨äºŽç”ŸæˆæŠ¥å‘Šï¼‰
    def is_new_version(self, unique_id, current_version):
        old = self.history.get(unique_id)
        if old is None: return False # ç¬¬ä¸€æ¬¡è¿è¡Œä¸è§†ä¸ºæ›´æ–°
        return old != current_version

    # æ›´æ–°çŠ¶æ€
    def update_status(self, unique_id, current_version):
        old = self.history.get(unique_id)
        if old != current_version:
            self.history[unique_id] = current_version
            return True, old
        return False, old

class GridAppCard(QFrame):
    def __init__(self, unique_id, app_data, version_mgr, parent=None):
        super().__init__(parent)
        self.setObjectName("GridCard")
        self.setFixedSize(120, 155)
        
        self.url = app_data.get("url", "")
        self.icon_url = app_data.get("icon", "")
        current_ver = str(app_data.get("version", "v?"))
        
        # è¿™é‡Œç›´æŽ¥æ›´æ–°çŠ¶æ€ï¼Œå› ä¸ºåœ¨MainWindowæ¸²æŸ“å‰æˆ‘ä»¬å·²ç»ç»Ÿè®¡è¿‡å·®å¼‚äº†
        is_new, old_ver = version_mgr.update_status(unique_id, current_ver)
        
        if is_new:
            self.setProperty("is_new", "true")
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(6, 10, 6, 6)
        layout.setSpacing(4)
        layout.setAlignment(Qt.AlignmentFlag.AlignTop)

        # 1. å›¾æ ‡
        icon_box = QHBoxLayout()
        self.icon_label = QLabel()
        self.icon_label.setFixedSize(48, 48)
        self.icon_label.setScaledContents(True)
        self.icon_label.setStyleSheet("background-color: transparent;")
        icon_box.addStretch()
        icon_box.addWidget(self.icon_label)
        icon_box.addStretch()
        layout.addLayout(icon_box)

        # 2. åå­—
        name_label = QLabel(app_data.get("name", "æœªå‘½å"))
        name_label.setObjectName("GridTitle")
        name_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        font_metrics = name_label.fontMetrics()
        elided = font_metrics.elidedText(name_label.text(), Qt.TextElideMode.ElideRight, 105)
        name_label.setText(elided)
        layout.addWidget(name_label)

        # 3. ç‰ˆæœ¬å·
        ver_label = QLabel(current_ver)
        ver_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        if is_new:
            ver_label.setObjectName("GridVerNew")
            ver_label.setText(f"ðŸš€ {current_ver}")
        else:
            ver_label.setObjectName("GridVer")
        layout.addWidget(ver_label)

        layout.addStretch()

        # 4. æŒ‰é’®
        btn_text = "æ›´æ–°" if is_new else "ä¸‹è½½"
        dl_btn = QPushButton(btn_text)
        dl_btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        dl_btn.setFixedHeight(28)
        
        if is_new:
            dl_btn.setStyleSheet("""
                QPushButton { background-color: #d93025; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; }
                QPushButton:hover { background-color: #b31412; }
            """)
        else:
            dl_btn.setStyleSheet("""
                QPushButton { background-color: #0078d4; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; }
                QPushButton:hover { background-color: #005a9e; }
            """)
            
        dl_btn.clicked.connect(self.download)
        layout.addWidget(dl_btn)

        if self.icon_url: self.load_icon()

    def load_icon(self):
        cache_path = get_cache_path(self.icon_url)
        if os.path.exists(cache_path):
            pixmap = QPixmap(cache_path)
            if not pixmap.isNull():
                self.icon_label.setPixmap(pixmap)
                return
        self.nam = QNetworkAccessManager()
        self.nam.finished.connect(lambda r: self.on_dl(r, cache_path))
        self.nam.get(QNetworkRequest(QUrl(self.icon_url)))

    def on_dl(self, reply, path):
        if reply.error() == 0:
            data = reply.readAll()
            if self.icon_label.setPixmap(QPixmap().loadFromData(data)): pass
            try: 
                with open(path, "wb") as f: f.write(data)
            except: pass
        reply.deleteLater()

    def download(self):
        if self.url: webbrowser.open(self.url)

class DataLoader(QThread):
    # ä¿¡å·å¢žåŠ ï¼šraw_txt_content (ok.txtçš„åŽŸå§‹å†…å®¹)
    data_loaded = pyqtSignal(list, str, str)
    error_occurred = pyqtSignal(str)

    def run(self):
        try:
            # 1. èŽ·å– JSON åˆ—è¡¨
            json_url = format_github_raw_url(TARGET_URL)
            resp_json = requests.get(json_url, timeout=30)
            resp_json.raise_for_status()
            data_list = resp_json.json()

            # 2. èŽ·å– ok.txt (ä¸ä»…èŽ·å–æ—¶é—´ï¼Œè¿˜èŽ·å–å…¨æ–‡)
            txt_url = format_github_raw_url(VERSION_INFO_URL)
            update_time = "æ—¶é—´èŽ·å–å¤±è´¥"
            raw_txt_content = ""
            
            try:
                resp_txt = requests.get(txt_url, timeout=15)
                if resp_txt.status_code == 200:
                    resp_txt.encoding = 'utf-8'
                    raw_txt_content = resp_txt.text
                    
                    # æå–æ—¶é—´ç”¨äºŽæ˜¾ç¤º
                    match = re.search(r"æ—¶é—´ >>\s*(\d{8}-\d{2}:\d{2}:\d{2})", raw_txt_content)
                    if match:
                        raw_time = match.group(1)
                        date_part = f"{raw_time[0:4]}-{raw_time[4:6]}-{raw_time[6:8]}"
                        time_part = raw_time[9:]
                        update_time = f"{date_part} {time_part}"
                    else:
                        # å¦‚æžœæ²¡æœ‰åŒ¹é…åˆ°æ­£åˆ™ï¼Œä½†æœ‰å†…å®¹ï¼Œå¯èƒ½æ ¼å¼å˜äº†ï¼Œç”¨å‰20ä¸ªå­—ç¬¦ä»£æ›¿
                        if len(raw_txt_content) > 0:
                            update_time = raw_txt_content.strip()[:20]
            except Exception as e:
                print(f"ok.txt èŽ·å–å¤±è´¥: {e}")

            self.data_loaded.emit(data_list, update_time, raw_txt_content)

        except Exception as e:
            self.error_occurred.emit(str(e))

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Fongmi æºèšåˆ (Lystvæº)")
        self.resize(950, 750) 
        self.version_mgr = VersionManager()
        self.current_log_content = "" # å­˜å‚¨å½“å‰çš„æ›´æ–°æ—¥å¿—
        ensure_cache_dir()
        self.set_window_icon_with_cache(FONGMI_ICON_URL)

        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)
        layout.setContentsMargins(0,0,0,0)
        layout.setSpacing(0)

        # === é¡¶éƒ¨æ  ===
        top_bar = QFrame()
        top_bar.setObjectName("TopBar")
        top_bar.setFixedHeight(50)
        tb_layout = QHBoxLayout(top_bar)
        tb_layout.setContentsMargins(20,0,20,0)
        
        # æ ‡é¢˜
        title_lbl = QLabel("åº”ç”¨èšåˆä¸­å¿ƒ")
        title_lbl.setStyleSheet("font-size: 18px; font-weight: bold; color: #333;")
        
        # æ—¶é—´æ ‡ç­¾
        self.time_lbl = QLabel("")
        self.time_lbl.setObjectName("TimeLabel")
        self.time_lbl.setAlignment(Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag.AlignVCenter)

        # æŸ¥çœ‹æ›´æ–°æŒ‰é’® (é»˜è®¤éšè—ï¼Œæœ‰æ›´æ–°æ—¶æ˜¾ç¤º)
        self.log_btn = QPushButton("ðŸ“‹ æŸ¥çœ‹æœ¬æ¬¡æ›´æ–°")
        self.log_btn.setVisible(False)
        self.log_btn.setFixedSize(110, 30)
        self.log_btn.setStyleSheet("""
            QPushButton { background-color: #fce8e6; border: 1px solid #d93025; border-radius: 4px; color: #d93025; font-weight: bold;}
            QPushButton:hover { background-color: #fad2cf; }
        """)
        self.log_btn.clicked.connect(self.show_update_log)

        # åˆ·æ–°æŒ‰é’®
        self.refresh_btn = QPushButton("åˆ·æ–°åˆ—è¡¨")
        self.refresh_btn.setFixedSize(80, 30)
        self.refresh_btn.setStyleSheet("""
            QPushButton { background-color: #fff; border: 1px solid #ccc; border-radius: 4px; color: #333; }
            QPushButton:hover { border: 1px solid #0078d4; color: #0078d4; }
        """)
        self.refresh_btn.clicked.connect(self.start_loading)
        
        tb_layout.addWidget(title_lbl)
        tb_layout.addStretch()
        tb_layout.addWidget(self.log_btn) # æ’å…¥æ›´æ–°æŒ‰é’®
        tb_layout.addWidget(self.time_lbl)
        tb_layout.addWidget(self.refresh_btn)
        layout.addWidget(top_bar)

        # æ»šåŠ¨åŒº
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setStyleSheet("QScrollArea { border: none; background: transparent; }")
        
        self.content_widget = QWidget()
        self.content_widget.setStyleSheet("background-color: #f2f3f5;")
        self.content_layout = QVBoxLayout(self.content_widget)
        self.content_layout.setContentsMargins(25, 10, 25, 40)
        self.content_layout.setSpacing(15)
        self.content_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        
        scroll.setWidget(self.content_widget)
        layout.addWidget(scroll)

        self.start_loading()

    def set_window_icon_with_cache(self, url):
        path = get_cache_path(url)
        if os.path.exists(path):
            self.setWindowIcon(QIcon(path))
            return
        self.inam = QNetworkAccessManager()
        self.inam.finished.connect(lambda r: self.on_wico(r, path))
        self.inam.get(QNetworkRequest(QUrl(url)))
    def on_wico(self, r, p):
        if r.error() == 0:
            d = r.readAll()
            self.setWindowIcon(QIcon(QPixmap().loadFromData(d)))
            try: open(p,"wb").write(d)
            except: pass
        r.deleteLater()

    def start_loading(self):
        self.refresh_btn.setEnabled(False)
        self.refresh_btn.setText("...")
        self.time_lbl.setText("æ­£åœ¨èŽ·å–...")
        self.log_btn.setVisible(False) # åˆ·æ–°æ—¶éšè—æ—¥å¿—æŒ‰é’®
        
        while self.content_layout.count():
            item = self.content_layout.takeAt(0)
            if item.widget(): item.widget().deleteLater()
            
        self.loader = DataLoader()
        self.loader.data_loaded.connect(self.on_loaded)
        self.loader.error_occurred.connect(lambda e: QMessageBox.warning(self,"æç¤º",e))
        self.loader.start()

    def on_loaded(self, data, time_str, raw_ok_content):
        self.refresh_btn.setEnabled(True)
        self.refresh_btn.setText("åˆ·æ–°åˆ—è¡¨")
        self.time_lbl.setText(f"æœ€æ–°ç»´æŠ¤: {time_str}")
        
        # === æ ¸å¿ƒé€»è¾‘ï¼šç”Ÿæˆæ›´æ–°æŠ¥å‘Š ===
        update_report = []
        
        # 1. æ£€æŸ¥ ok.txt å†…å®¹å˜åŠ¨
        old_ok_content = ""
        if os.path.exists(LAST_OK_FILE):
            try:
                with open(LAST_OK_FILE, "r", encoding="utf-8") as f:
                    old_ok_content = f.read()
            except: pass
        
        if old_ok_content.strip() != raw_ok_content.strip():
            # å†…å®¹å˜äº†ï¼Œè®°å½•ä¸‹æ¥
            update_report.append(f"ã€ç»´æŠ¤å…¬å‘Šå˜æ›´ã€‘\næ—§ï¼š{old_ok_content.strip()[:50]}...\næ–°ï¼š{raw_ok_content.strip()[:50]}...\n")
        
        # 2. æ‰«ææ‰€æœ‰ App æ£€æŸ¥ç‰ˆæœ¬å˜åŠ¨
        updated_apps = []
        # æž„å»ºIDç”Ÿæˆé€»è¾‘ï¼Œå¿…é¡»ä¸Ž render_group ä¸­çš„ä¸€è‡´
        temp_id_counter = {}
        for cat in data:
            cat_name = cat.get("name", "")
            for app in cat.get("list", []):
                app_name = app.get("name", "")
                base = f"{cat_name}_{app_name}"
                count = temp_id_counter.get(base, 0) + 1
                temp_id_counter[base] = count
                uid = f"{base}#{count}" if count > 1 else base
                
                # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦æ˜¯æ–°çš„ (æ³¨æ„ï¼šè¿™é‡Œåªæ£€æŸ¥ä¸æ›´æ–°çŠ¶æ€ï¼ŒçŠ¶æ€åœ¨æ¸²æŸ“Cardæ—¶æ›´æ–°)
                ver = str(app.get("version", ""))
                if self.version_mgr.is_new_version(uid, ver):
                    updated_apps.append(f"â€¢ {app_name} ({ver})")
        
        if updated_apps:
            update_report.append("ã€æ£€æµ‹åˆ°åº”ç”¨æ›´æ–°ã€‘")
            update_report.extend(updated_apps)
        
        # 3. å¤„ç†æŠ¥å‘Šç»“æžœ
        if update_report:
            full_log = "\n".join(update_report)
            full_log += f"\n\n(å®Œæ•´ç»´æŠ¤ä¿¡æ¯)\n{raw_ok_content}"
            self.current_log_content = full_log
            self.log_btn.setVisible(True) # æ˜¾ç¤ºæŒ‰é’®
            
            # ä¿å­˜æ–°çš„ ok.txt åˆ°æœ¬åœ°
            try:
                with open(LAST_OK_FILE, "w", encoding="utf-8") as f:
                    f.write(raw_ok_content)
            except: pass
        else:
            self.current_log_content = "æš‚æ— æ£€æµ‹åˆ°æ–°æ—§å†…å®¹å˜åŠ¨ã€‚\n\nå½“å‰ç»´æŠ¤ä¿¡æ¯ï¼š\n" + raw_ok_content
        
        # === æ¸²æŸ“ç•Œé¢ ===
        for cat in data:
            self.render_group(cat)
        self.version_mgr.save()

    def show_update_log(self):
        dlg = LogDialog(self.current_log_content, self)
        dlg.exec()

    def render_group(self, cat_data):
        name = cat_data.get("name", "")
        apps = cat_data.get("list", [])
        if not apps: return

        header = QLabel(f"{name}")
        header.setObjectName("GroupHeader")
        self.content_layout.addWidget(header)

        grid_container = QWidget()
        grid = QGridLayout(grid_container)
        grid.setContentsMargins(0,0,0,15)
        grid.setSpacing(12)
        grid.setAlignment(Qt.AlignmentFlag.AlignLeft | Qt.AlignmentFlag.AlignTop)
        
        cols = 6 
        id_counter = {}

        for i, app in enumerate(apps):
            r, c = i // cols, i % cols
            base = f"{name}_{app.get('name')}"
            count = id_counter.get(base, 0) + 1
            id_counter[base] = count
            uid = f"{base}#{count}" if count > 1 else base
            
            card = GridAppCard(uid, app, self.version_mgr)
            grid.addWidget(card, r, c)
            
        self.content_layout.addWidget(grid_container)

if __name__ == "__main__":
    app = QApplication.instance() or QApplication(sys.argv)
    app.setStyleSheet(STYLESHEET)
    font = QFont("Microsoft YaHei", 9)
    app.setFont(font)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())
