import os
# import random # æ­¤è„šæœ¬ä¸­å·²ä¸å†ä½¿ç”¨ random_colorï¼Œå¯ç§»é™¤
import requests
import subprocess # å¯¼å…¥ subprocess
import sys # å¯¼å…¥ sys
import shutil
import tkinter as tk
from tkinter import ttk
# import re # æ­¤è„šæœ¬ä¸­å·²ä¸å†ä½¿ç”¨ remove_ansi_escapeï¼Œå¯ç§»é™¤
import json
import threading  # å¯¼å…¥ threading

# è®¾ç½® APK ç‰ˆæœ¬å· JSON æ–‡ä»¶æ‰€åœ¨ç›®å½•
# ç¡®ä¿æ­¤ç›®å½•å­˜åœ¨æˆ–å¤„ç†åˆ›å»º
VERSION_DIR = "F:/Program Files/Git/storage/SHä¸‹è½½æ–‡ä»¶/ç‰ˆæœ¬æ–‡ä»¶å¤¹"
os.makedirs(VERSION_DIR, exist_ok=True) # ç¡®ä¿ç›®å½•å­˜åœ¨

# è®¾ç½® GitHub ç”¨æˆ·ä»£ç†
USER_AGENT = "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Mobile Safari/537.36 EdgA/121.0.0.0"

# è®¾ç½® GitHub ä»“åº“åœ°å€ (ä»…ä½œä¸ºä¿¡æ¯ï¼Œä¸ç›´æ¥ç”¨äºæ„å»ºURL)
# REPO = "hc990275/apkdown" # æ­¤å˜é‡æœªç›´æ¥ä½¿ç”¨

# Random color function (æœªåœ¨GUIæ—¥å¿—ä¸­ä½¿ç”¨ï¼Œå¯ç§»é™¤)
# def random_color():
#     return random.randint(31, 37) # ä» 31 åˆ° 37 çš„é¢œè‰²ä»£ç 

# Remove ANSI escape characters (æœªåœ¨GUIæ—¥å¿—ä¸­ä½¿ç”¨ï¼Œå¯ç§»é™¤)
# def remove_ansi_escape(text):
#     ansi_escape = re.compile(r'(?:\x1b[^m]*m)|(?:\x1b[^m]*\[.*?m)')
#     return ansi_escape.sub('', text)

# APK JSON ä¸‹è½½åœ°å€ (raw content URL)
urls = {
    "OKç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/lystv/fmapp/main/apk/release/mobile.json",  # OKç‰ˆæ‰‹æœº JSON åœ°å€ (æœªå˜æ›´)
    "OKç‰ˆç”µè§†": "https://raw.githubusercontent.com/lystv/fmapp/main/apk/release/leanback.json", # OKç‰ˆç”µè§† JSON åœ°å€ (æœªå˜æ›´)
    "èœœèœ‚ç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/release/mobile.json", # æœªå˜æ›´
    "èœœèœ‚ç‰ˆç”µè§†": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/release/leanback.json", # æœªå˜æ›´
    "OKç‰ˆPro": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/pro/v.txt"  # !!! æ›´æ–° OKç‰ˆPro JSON åœ°å€ !!!
}

# APK ä¸‹è½½é“¾æ¥ (å­˜å‚¨çš„æ˜¯ relative path from raw.githubusercontent.com/)
# Base URL æ˜¯ https://raw.githubusercontent.com/
apk_links = {
    # OKç‰ˆ (ä½¿ç”¨ lystv/fmapp ä»“åº“, ä¸åŒºåˆ† Java/Python) - æœªå˜æ›´
    "OKç‰ˆæ‰‹æœº_32": "lystv/fmapp/main/apk/release/mobile-armeabi_v7a.apk",
    "OKç‰ˆæ‰‹æœº_64": "lystv/fmapp/main/apk/release/mobile-arm64_v8a.apk",

    "OKç‰ˆç”µè§†_32": "lystv/fmapp/main/apk/release/leanback-armeabi_v7a.apk",
    "OKç‰ˆç”µè§†_64": "lystv/fmapp/main/apk/release/leanback-arm64_v8a.apk",

    # OKæµ·ä¿¡ä¸“ç‰ˆ (ä¸OKç‰ˆæ‰‹æœºç‰ˆæœ¬å·ä¸€è‡´) - æœªå˜æ›´
    "OKæµ·ä¿¡ä¸“ç‰ˆ_APK": "lystv/fmapp/main/apk/release/%E6%B5%B7%E4%BF%A1%E4%B8%93%E7%89%88.apk", # (%E6%B5%B7%E4%BF%A1%E4%B8%93%E7%89%88 æ˜¯ "æµ·ä¿¡ä¸“ç‰ˆ" çš„ URL ç¼–ç )

    # OKå®‰å“4ç‰ˆæœ¬ (KitKat), ç‹¬ç«‹ä¸‹è½½ - æœªå˜æ›´
    "OKå®‰å“4ç‰ˆæœ¬_APK": "lystv/fmapp/main/apk/kitkat/leanback.apk",

    # OKç‰ˆPro (ä½¿ç”¨ lystv/fmapp ä»“åº“, ok åˆ†æ”¯) - !!! æ›´æ–° OKç‰ˆPro APK è·¯å¾„ !!!
    "OKç‰ˆPro_æ‰‹æœºPro": "lystv/fmapp/ok/apk/pro/mobile-pro.apk",
    "OKç‰ˆPro_æ‰‹æœºemu-Pro": "lystv/fmapp/ok/apk/pro/mobile-emu-pro.apk",
    "OKç‰ˆPro_ç”µè§†Pro": "lystv/fmapp/ok/apk/pro/leanback-pro.apk",


    # èœœèœ‚ç‰ˆ (ä½¿ç”¨ FongMi/Release ä»“åº“, åŒºåˆ† Java/Python) - æœªå˜æ›´
    "èœœèœ‚ç‰ˆæ‰‹æœº_PY32": "fongmi/apk/release/mobile-python-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆæ‰‹æœº_PY64": "fongmi/apk/release/mobile-python-arm64_v8a.apk",
    "èœœèœ‚ç‰ˆæ‰‹æœº_JAVA32": "fongmi/apk/release/mobile-java-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆæ‰‹æœº_JAVA64": "fongmi/apk/release/mobile-java-arm64_v8a.apk",

    "èœœèœ‚ç‰ˆç”µè§†_PY32": "fongmi/apk/release/leanback-python-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_PY64": "fongmi/apk/release/leanback-python-arm64_v8a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_JAVA32": "fongmi/apk/release/leanback-java-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_JAVA64": "fongmi/apk/release/leanback-java-arm64_v8a.apk",
}

# ä¸‹è½½ç›®å½•
download_dir = "F:/Program Files/Git/storage/SHä¸‹è½½æ–‡ä»¶"
version_folder = os.path.join(download_dir, "ç‰ˆæœ¬æ–‡ä»¶å¤¹")
os.makedirs(download_dir, exist_ok=True) # ç¡®ä¿ä¸‹è½½ç›®å½•å­˜åœ¨
os.makedirs(version_folder, exist_ok=True) # ç¡®ä¿ç‰ˆæœ¬æ–‡ä»¶å¤¹å­˜åœ¨


# --- GUI Update Helper Functions (Thread-safe) ---
# è¿™äº›å‡½æ•°ç”±åå°çº¿ç¨‹è°ƒç”¨ï¼Œç”¨äºå®‰å…¨åœ°åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°GUI

def append_log_safe(message):
    # åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒåº¦å‘æ—¥å¿—æ–‡æœ¬æ¡†æ·»åŠ æ¶ˆæ¯
    root.after(0, _append_log_gui, message)

def _append_log_gui(message):
    # å®é™…æ›´æ–°GUIæ—¥å¿—æ–‡æœ¬çš„å‡½æ•°
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END) # è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

def update_progress_safe(value):
    # åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒåº¦æ›´æ–°è¿›åº¦æ¡çš„å€¼
    root.after(0, _update_progress_gui, value)

def _update_progress_gui(value):
    # å®é™…æ›´æ–°GUIè¿›åº¦æ¡çš„å‡½æ•°
    progress_bar['value'] = value

# def enable_button_safe(button): # ä¸å†å•ç‹¬ä½¿ç”¨è¿™äº›ï¼Œç”± set_all_buttons_state ç»Ÿä¸€ç®¡ç†
#     root.after(0, lambda: button.config(state=tk.NORMAL))
# def disable_button_safe(button):
#      root.after(0, lambda: button.config(state=tk.DISABLED))

def set_all_buttons_state(state):
    """å®‰å…¨åœ°è®¾ç½®æ‰€æœ‰ç›¸å…³æŒ‰é’®çš„çŠ¶æ€ (DISABLED æˆ– NORMAL)ã€‚"""
    # ä½¿ç”¨ root.after ç¡®ä¿åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
    root.after(0, _set_all_buttons_gui, state)

def _set_all_buttons_gui(state):
     """å®é™…è®¾ç½®æ‰€æœ‰ç›¸å…³æŒ‰é’®çš„çŠ¶æ€ã€‚"""
     # ç¡®ä¿æŒ‰é’®æ§ä»¶å·²åˆ›å»ºå¹¶ä¸ºå…¨å±€å˜é‡ï¼Œå¹¶æ£€æŸ¥æ§ä»¶æ˜¯å¦å­˜åœ¨
     # ä½¿ç”¨ globals().get() æ›´å®‰å…¨ï¼Œé¿å… NameError å¦‚æœåœ¨æŒ‰é’®åˆ›å»ºå‰è°ƒç”¨
     if 'start_button' in globals() and start_button.winfo_exists():
         start_button.config(state=state)
     if 'open_dir_button' in globals() and open_dir_button.winfo_exists():
         # æ‰“å¼€ç›®å½•æŒ‰é’®é€šå¸¸å¯ä»¥åœ¨ä»»ä½•æ—¶å€™ä½¿ç”¨ï¼Œé™¤éå®ƒè‡ªå·±æ­£åœ¨æ‰§è¡Œä»»åŠ¡
         # ä½†æ˜¯ä¸ºäº†ç®€åŒ–çŠ¶æ€ç®¡ç†ï¼Œæˆ‘ä»¬åœ¨ä»»ä½•ä¸‹è½½/æ›´æ–°ä»»åŠ¡è¿›è¡Œæ—¶ç¦ç”¨å®ƒ
         open_dir_button.config(state=state)
     if 'kitkat_button' in globals() and kitkat_button.winfo_exists():
         kitkat_button.config(state=state)


# --- OS Interaction Functions ---

def open_download_directory():
    """åœ¨æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰“å¼€ä¸‹è½½ç›®å½•ã€‚"""
    # è¿™é‡Œä¸ç¦ç”¨æ‰€æœ‰æŒ‰é’®ï¼Œå› ä¸ºæ‰“å¼€ç›®å½•æ“ä½œé€šå¸¸å¾ˆå¿«ä¸”ç‹¬ç«‹
    # set_all_buttons_state(tk.DISABLED) # å¯ä»¥é€‰æ‹©åœ¨è¿™é‡Œç¦ç”¨ï¼Œå¹¶åœ¨finallyé‡æ–°å¯ç”¨

    target_dir = os.path.realpath(download_dir) # è·å–ç»å¯¹è·¯å¾„
    append_log_safe(f"å°è¯•æ‰“å¼€ç›®å½•: {target_dir}")

    try:
        if sys.platform == "win32":
            # Windows: ä½¿ç”¨ os.startfileï¼Œè¿™æ˜¯ Windows API è°ƒç”¨ï¼Œä¸ä¼šåœ¨æˆåŠŸæ—¶æŠ›å¼‚å¸¸
            os.startfile(target_dir)
        elif sys.platform == "darwin":
            # macOS
            subprocess.run(['open', target_dir], check=True)
        elif sys.platform.startswith('linux'):
            # Linux (ä½¿ç”¨ xdg-open)
            subprocess.run(['xdg-open', target_dir], check=True)
        else:
            append_log_safe(f"âš ï¸ è­¦å‘Š: ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ '{sys.platform}'ï¼Œæ— æ³•è‡ªåŠ¨æ‰“å¼€ç›®å½•ã€‚")
            return

        append_log_safe("æˆåŠŸæ‰“å¼€ä¸‹è½½ç›®å½•ã€‚")

    except FileNotFoundError:
         append_log_safe(f"âŒ é”™è¯¯: æœªæ‰¾åˆ°æ‰“å¼€ç›®å½•çš„å‘½ä»¤æˆ–ç›®å½•ä¸å­˜åœ¨: {target_dir}")
    except Exception as e:
        # æ•è·é™¤ FileNotFoundError å¤–çš„å…¶ä»–å¼‚å¸¸ (ä¸»è¦æ¥è‡ªéWindowsä¸Šçš„ subprocess.run)
        append_log_safe(f"âŒ æ‰“å¼€ç›®å½•æ—¶å‘ç”Ÿé”™è¯¯: {e}")
    # finally:
    #     set_all_buttons_state(tk.NORMAL) # å¦‚æœä¸Šé¢ç¦ç”¨äº†ï¼Œåœ¨è¿™é‡Œé‡æ–°å¯ç”¨


# --- Core Logic Functions (åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œ) ---

# ä¸‹è½½ JSON å¹¶æ¯”è¾ƒç‰ˆæœ¬å· (å…¼å®¹ OKç‰ˆPro çš„ v.txt çº¯æ–‡æœ¬ç‰ˆæœ¬å·)
def check_json_update(name):
    url = urls[name]
    old_json_file = os.path.join(version_folder, f"{name}.json")
    new_json_file = os.path.join(version_folder, f"{name}ä¸´æ—¶.json")
    updated = False

    append_log_safe(f"æ­£åœ¨æ£€æŸ¥ {name} çš„ç‰ˆæœ¬...")

    try:
        # å¢åŠ è¶…æ—¶è®¾ç½®ï¼Œå¹¶ä½¿ç”¨ headers
        response = requests.get(url, headers={'User-Agent': USER_AGENT}, timeout=10)
        response.raise_for_status() # æ£€æŸ¥HTTPè¯·æ±‚æ˜¯å¦æˆåŠŸ (ä¾‹å¦‚404, 500é”™è¯¯)
        with open(new_json_file, 'wb') as f:
            f.write(response.content)
        append_log_safe(f"æˆåŠŸä¸‹è½½ {name} çš„æ–°ç‰ˆæœ¬ä¿¡æ¯.")
    except requests.exceptions.RequestException as e:
        # æ•è·æ‰€æœ‰requestsç›¸å…³çš„å¼‚å¸¸ (è¿æ¥é”™è¯¯, HTTPé”™è¯¯, è¶…æ—¶ç­‰)
        append_log_safe(f"âš ï¸ ä¸‹è½½ {name} ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥ï¼Œé”™è¯¯ï¼š{e}")
        # ä¸‹è½½å¤±è´¥ååˆ é™¤ä¸´æ—¶æ–‡ä»¶
        if os.path.exists(new_json_file):
             try:
                 os.remove(new_json_file)
             except Exception as rm_e:
                 append_log_safe(f"âš ï¸ åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {new_json_file} - {rm_e}")
        return False # JSON ä¸‹è½½å¤±è´¥è¿”å› False
    except Exception as e:
        # æ•è·å…¶ä»–å¯èƒ½çš„å¼‚å¸¸
        append_log_safe(f"âš ï¸ å¤„ç† {name} ç‰ˆæœ¬ä¿¡æ¯æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼š{e}")
        if os.path.exists(new_json_file):
             try:
                 os.remove(new_json_file)
             except Exception as rm_e:
                 append_log_safe(f"âš ï¸ åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {new_json_file} - {rm_e}")
        return False # å…¶ä»–é”™è¯¯ä¹Ÿè¿”å› False


    old_version = ""
    new_version = ""

    # åˆ¤æ–­æ˜¯å¦ä¸º OKç‰ˆPro (v.txt çº¯æ–‡æœ¬ç‰ˆæœ¬å·)
    if name == "OKç‰ˆPro":
        # OKç‰ˆPro JSON (v.txt) å¤„ç†é€»è¾‘ (çº¯æ–‡æœ¬ç‰ˆæœ¬å·)
        if os.path.exists(old_json_file):
            try:
                # ä½¿ç”¨ with...as ç¡®ä¿æ–‡ä»¶è¢«å…³é—­
                with open(old_json_file, "r", encoding='utf-8') as f:
                    old_version = f.readline().strip() # è¯»å–ç¬¬ä¸€è¡Œå¹¶å»æ‰ç©ºç™½ç¬¦
            except Exception as file_e:
                append_log_safe(f"âš ï¸ è¯»å–æ—§ç‰ˆæœ¬æ–‡ä»¶ {old_json_file} å¤±è´¥: {file_e}")
                old_version = "Error reading old file" # æ ‡è®°è¯»å–å¤±è´¥
        try:
            # ä½¿ç”¨ with...as ç¡®ä¿æ–‡ä»¶è¢«å…³é—­
            with open(new_json_file, "r", encoding='utf-8') as f:
                new_version = f.readline().strip() # è¯»å–ç¬¬ä¸€è¡Œå¹¶å»æ‰ç©ºç™½ç¬¦
        except Exception as file_e:
             append_log_safe(f"âš ï¸ è¯»å–æ–°ç‰ˆæœ¬æ–‡ä»¶ {new_json_file} å¤±è´¥: {file_e}")
             new_version = "Error reading new file" # æ ‡è®°è¯»å–å¤±è´¥
    else:
        # å…¶ä»– JSON å¤„ç†é€»è¾‘ (JSON æ ¼å¼ç‰ˆæœ¬å·)
        if os.path.isfile(old_json_file):
            try:
                # ä½¿ç”¨ with...as ç¡®ä¿æ–‡ä»¶è¢«å…³é—­
                with open(old_json_file, 'r', encoding='utf-8') as f:
                    old_json_data = json.load(f)
                    old_version = old_json_data.get("name", "")
            except (json.JSONDecodeError, Exception) as e:
                append_log_safe(f"âš ï¸ è§£ææ—§ç‰ˆæœ¬ JSON æ–‡ä»¶å¤±è´¥: {old_json_file} - {e}")
                old_version = "Error parsing old JSON" # æ ‡è®°è§£æå¤±è´¥

        try:
            # ä½¿ç”¨ with...as ç¡®ä¿æ–‡ä»¶è¢«å…³é—­
            with open(new_json_file, 'r', encoding='utf-8') as f:
                new_json_data = json.load(f)
                new_version = new_json_data.get("name", "")
        except (json.JSONDecodeError, Exception) as e:
            append_log_safe(f"âš ï¸ è§£ææ–°ç‰ˆæœ¬ JSON æ–‡ä»¶å¤±è´¥: {new_json_file} - {e}")
            new_version = "Error parsing new JSON" # æ ‡è®°è§£æå¤±è´¥


    append_log_safe(f"{name} æ—§ç‰ˆæœ¬å·: {old_version if old_version else 'æœªæ‰¾åˆ°'}")
    append_log_safe(f"{name} æ–°ç‰ˆæœ¬å·: {new_version if new_version else 'æœªæ‰¾åˆ°'}")

    # å¦‚æœæˆåŠŸè·å–åˆ°æ–°ç‰ˆæœ¬å·ï¼Œå¹¶ä¸”æ–°ç‰ˆæœ¬å·ä¸ä¸ºç©ºä¸”ä¸æ—§ç‰ˆæœ¬å·ä¸åŒ
    if new_version and new_version != old_version:
        append_log_safe(f"ğŸš€ å‘ç° {name} æ–°ç‰ˆæœ¬ï¼Œæ›´æ–°æœ¬åœ°ç‰ˆæœ¬ä¿¡æ¯å¹¶å‡†å¤‡ä¸‹è½½ APK...")
        try:
            shutil.copy(new_json_file, old_json_file)
            updated = True
        except Exception as copy_e:
             append_log_safe(f"âš ï¸ å¤åˆ¶æ–°ç‰ˆæœ¬æ–‡ä»¶å¤±è´¥: {copy_e}")
             updated = False # å¤åˆ¶å¤±è´¥ï¼Œæ ‡è®°ä¸ºæœªæ›´æ–°ï¼Œä¸è¿›è¡Œä¸‹è½½
    else:
        append_log_safe(f"{name} ç‰ˆæœ¬æœªå˜æ›´æˆ–æ— æ³•è·å–æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ— éœ€æ›´æ–°ã€‚")
        updated = False # æœªæ›´æ–°

    # åœ¨å‡½æ•°æœ«å°¾ï¼Œæ— è®ºæ˜¯å¦æ›´æ–°ï¼Œéƒ½åˆ é™¤ä¸´æ—¶ JSON æ–‡ä»¶
    try:
        if os.path.exists(new_json_file):
           os.remove(new_json_file)
    except Exception as e:
        append_log_safe(f"âš ï¸ åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {new_json_file} - {e}")

    return updated # è¿”å› updated æ ‡è®°

# ä¸‹è½½ APK
def download_apk(apk_name):
    # é‡ç½®è¿›åº¦æ¡ä¸ºå½“å‰ APK çš„ä¸‹è½½å‡†å¤‡
    update_progress_safe(0)

    # æ„å»ºå®Œæ•´çš„ APK ä¸‹è½½ URL
    # apk_links ä¸­å­˜å‚¨çš„æ˜¯ä» raw.githubusercontent.com/ å¼€å§‹çš„è·¯å¾„
    # ä¾‹å¦‚: 'lystv/fmapp/main/apk/release/mobile-armeabi_v7a.apk'
    try:
        relative_path = apk_links[apk_name]
        apk_url = f"https://raw.githubusercontent.com/{relative_path}"
    except KeyError:
        append_log_safe(f"é”™è¯¯ï¼šåœ¨ apk_links ä¸­æœªæ‰¾åˆ°åç§°ä¸º '{apk_name}' çš„æ¡ç›®ï¼Œæ— æ³•æ„å»ºä¸‹è½½ URLã€‚")
        update_progress_safe(0)
        return

    # å°† APK åç§°ä¸­çš„ç‰¹æ®Šå­—ç¬¦è½¬æ¢ä¸ºæ–‡ä»¶åå®‰å…¨çš„æ ¼å¼ï¼ˆä¾‹å¦‚ç§»é™¤ "_APK" åç¼€ï¼Œå¤„ç†ä¸­æ–‡ç­‰ï¼‰
    # è¿™é‡Œç®€å•å¤„ç†ï¼Œåªç§»é™¤ "_APK" åç¼€
    clean_apk_name = apk_name.replace("_APK", "")
    # æ„å»ºå®Œæ•´çš„æœ¬åœ°ä¿å­˜è·¯å¾„
    apk_path = os.path.join(download_dir, f"{clean_apk_name}.apk")


    append_log_safe(f"ğŸ“¥ æ­£åœ¨ä¸‹è½½: {clean_apk_name}.apk") # æ—¥å¿—ä¸­æ˜¾ç¤ºå¹²å‡€çš„åç§°

    try:
        # ä½¿ç”¨ stream=True è¿›è¡Œåˆ†å—ä¸‹è½½ï¼Œå¢åŠ è¶…æ—¶è®¾ç½®å’Œ headers
        response = requests.get(apk_url, stream=True, headers={'User-Agent': USER_AGENT}, timeout=60)
        response.raise_for_status() # æ£€æŸ¥HTTPè¯·æ±‚æ˜¯å¦æˆåŠŸ (ä¾‹å¦‚404, 500ç­‰é”™è¯¯)

        # è·å–æ–‡ä»¶æ€»å¤§å°ï¼Œå¦‚æœ Content-Length ä¸å¯ç”¨ï¼Œè®¾ä¸º0
        total_size = int(response.headers.get('content-length', 0))
        downloaded = 0

        # åˆ†å—å†™å…¥æ–‡ä»¶å¹¶æ›´æ–°è¿›åº¦æ¡
        with open(apk_path, 'wb') as f:
            # éå†å“åº”å†…å®¹ï¼ŒæŒ‰å—è¯»å–
            for data in response.iter_content(chunk_size=8192): # å¯ä»¥è°ƒæ•´å—å¤§å°
                f.write(data)
                downloaded += len(data)
                # æ›´æ–°è¿›åº¦æ¡ (å¦‚æœå·²çŸ¥æ€»å¤§å°)
                if total_size > 0:
                    # è®¡ç®—å½“å‰è¿›åº¦ç™¾åˆ†æ¯”
                    progress = int((downloaded / total_size) * 100)
                    # å®‰å…¨åœ°æ›´æ–°GUIä¸Šçš„è¿›åº¦æ¡
                    update_progress_safe(progress)
                # else:
                    # å¦‚æœæ€»å¤§å°æœªçŸ¥ï¼Œå½“å‰ mode="determinate" ä¸æ”¯æŒå¹³æ»‘æ›´æ–°

        append_log_safe(f"âœ… ä¸‹è½½å®Œæˆ: {clean_apk_name}.apk") # æ—¥å¿—ä¸­æ˜¾ç¤ºå¹²å‡€çš„åç§°
        update_progress_safe(100) # ç¡®ä¿ä¸‹è½½å®Œæˆåè¿›åº¦æ¡æ˜¾ç¤º100%

    except requests.exceptions.RequestException as e:
        # æ•è·æ‰€æœ‰requestsç›¸å…³çš„å¼‚å¸¸ (è¿æ¥é”™è¯¯, HTTPé”™è¯¯, è¶…æ—¶ç­‰)
        append_log_safe(f"âŒ APK ä¸‹è½½å¤±è´¥ï¼Œé”™è¯¯ï¼š{e}")
        # ä¸‹è½½å¤±è´¥æ—¶é‡ç½®è¿›åº¦æ¡
        update_progress_safe(0)
        # å¯é€‰ï¼šå¦‚æœä¸‹è½½å¤±è´¥ï¼Œåˆ é™¤ä¸å®Œæ•´çš„ä¸´æ—¶æ–‡ä»¶
        if os.path.exists(apk_path):
            try:
                os.remove(apk_path)
                append_log_safe(f"å·²åˆ é™¤ä¸å®Œæ•´çš„ä¸‹è½½æ–‡ä»¶: {apk_path}")
            except Exception as rm_e:
                append_log_safe(f"âš ï¸ åˆ é™¤ä¸å®Œæ•´æ–‡ä»¶å¤±è´¥: {apk_path} - {rm_e}")

    except Exception as e:
        # æ•è·å…¶ä»–å¯èƒ½çš„å¼‚å¸¸ (æ–‡ä»¶å†™å…¥é”™è¯¯ç­‰)
        append_log_safe(f"âŒ ä¸‹è½½è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼š{e}")
        # å‘ç”Ÿé”™è¯¯æ—¶é‡ç½®è¿›åº¦æ¡
        update_progress_safe(0)
        # åŒä¸Šï¼Œåˆ é™¤ä¸å®Œæ•´çš„ä¸´æ—¶æ–‡ä»¶
        if os.path.exists(apk_path):
            try:
                os.remove(apk_path)
                append_log_safe(f"å·²åˆ é™¤ä¸å®Œæ•´çš„ä¸‹è½½æ–‡ä»¶: {apk_path}")
            except Exception as rm_e:
                append_log_safe(f"âš ï¸ åˆ é™¤ä¸å®Œæ•´æ–‡ä»¶å¤±è´¥: {apk_path} - {rm_e}")


# --- åå°ä»»åŠ¡æ‰§è¡Œå‡½æ•° ---

def _run_kitkat_download():
    """åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œä¸‹è½½ OK å®‰å“4ç‰ˆæœ¬ APK çš„ä»»åŠ¡ã€‚"""
    try:
        append_log_safe("--- å¼€å§‹ä¸‹è½½ OK å®‰å“4ç‰ˆæœ¬ ---")
        update_progress_safe(0) # é‡ç½®è¿›åº¦æ¡
        download_apk("OKå®‰å“4ç‰ˆæœ¬_APK") # è°ƒç”¨ download_apk
        append_log_safe("--- OK å®‰å“4ç‰ˆæœ¬ä¸‹è½½å®Œæˆ ---")
    except Exception as e:
        # Note: download_apk itself logs errors, this catches unexpected issues
        append_log_safe(f"âš ï¸ ä¸‹è½½ OK å®‰å“4ç‰ˆæœ¬ä»»åŠ¡å¼‚å¸¸ç»ˆæ­¢: {e}")
    finally:
        # ä»»åŠ¡å®Œæˆåé‡æ–°å¯ç”¨æ‰€æœ‰æŒ‰é’®
        set_all_buttons_state(tk.NORMAL)


# --- ä¸»è¦æ›´æ–°é€»è¾‘ (åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œ) ---

def run_update_logic():
    """åŒ…å«æ£€æŸ¥æ›´æ–°å’Œä¸‹è½½APKçš„ä¸»è¦å¾ªç¯é€»è¾‘ï¼Œåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œã€‚"""
    # åœ¨å¼€å§‹å‰ç¦ç”¨æ‰€æœ‰æŒ‰é’®
    set_all_buttons_state(tk.DISABLED)
    # æ¸…ç©ºæ—¥å¿—åŒºåŸŸï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æƒ³ä¿ç•™ä¸Šæ¬¡çš„æ—¥å¿—åˆ™å–æ¶ˆæ³¨é‡Šï¼‰
    # root.after(0, log_text.delete, '1.0', tk.END)

    append_log_safe("--- å¼€å§‹æ£€æŸ¥æ‰€æœ‰ç‰ˆæœ¬æ›´æ–° ---")
    update_progress_safe(0) # å¼€å§‹æ—¶é‡ç½®æ€»ä½“è¿›åº¦æ¡

    try:
        # éå†æ‰€æœ‰å®šä¹‰çš„ç‰ˆæœ¬ç±»å‹
        for name in urls.keys():
            # æ¯æ¬¡æ£€æŸ¥æˆ–ä¸‹è½½å‰ï¼Œé‡ç½®è¿›åº¦æ¡åˆ°0
            update_progress_safe(0)
            # æ£€æŸ¥å½“å‰ç‰ˆæœ¬æ˜¯å¦æœ‰æ›´æ–°
            # è°ƒç”¨ check_json_update
            if check_json_update(name):
                # å¦‚æœæœ‰æ›´æ–°ï¼Œæ ¹æ®ç‰ˆæœ¬åç§°ä¸‹è½½å¯¹åº”çš„æ‰€æœ‰APK
                append_log_safe(f"\nğŸ§© {name} æ£€æµ‹åˆ°æœ‰æ›´æ–°ï¼Œå‡†å¤‡ä¸‹è½½ç›¸å…³ APKs...")
                apks_to_download = []
                if name == "OKç‰ˆPro":
                    # OKç‰ˆPro ä¸‹è½½åˆ—è¡¨
                    apks_to_download = [
                        "OKç‰ˆPro_æ‰‹æœºPro",
                        "OKç‰ˆPro_æ‰‹æœºemu-Pro",
                        "OKç‰ˆPro_ç”µè§†Pro"
                    ]
                elif name == "OKç‰ˆæ‰‹æœº":
                    # OKç‰ˆæ‰‹æœº (ä¸åŒºåˆ† Java/Python, åªåŒºåˆ† 32/64) ä¸”åŒ…å«æµ·ä¿¡ä¸“ç‰ˆ
                    apks_to_download = [
                        f"{name}_32", # æ³¨æ„è¿™é‡Œæ˜¯ _32 å’Œ _64
                        f"{name}_64",
                        "OKæµ·ä¿¡ä¸“ç‰ˆ_APK" # æ·»åŠ æµ·ä¿¡ä¸“ç‰ˆ
                    ]
                    append_log_safe("åŒ…å« OK æµ·ä¿¡ä¸“ç‰ˆ APK (ç‰ˆæœ¬å·ä¸ OKç‰ˆæ‰‹æœºä¸€è‡´)...")
                elif name == "OKç‰ˆç”µè§†":
                     # OKç‰ˆç”µè§† (ä¸åŒºåˆ† Java/Python, åªåŒºåˆ† 32/64)
                     apks_to_download = [
                        f"{name}_32",
                        f"{name}_64"
                    ]
                else: # èœœèœ‚ç‰ˆæ‰‹æœº, èœœèœ‚ç‰ˆç”µè§† (åŒºåˆ† Java/Python)
                     apks_to_download = [
                        f"{name}_PY32",
                        f"{name}_PY64",
                        f"{name}_JAVA32",
                        f"{name}_JAVA64"
                    ]


                # éå†åˆ—è¡¨ï¼Œé€ä¸ªä¸‹è½½ APK
                for apk_name in apks_to_download:
                     # ç¡®ä¿ apk_links ä¸­å­˜åœ¨æ­¤åç§°ï¼Œé¿å… KeyError
                     if apk_name in apk_links:
                         download_apk(apk_name) # è°ƒç”¨ download_apk
                         # å¯é€‰ï¼šåœ¨ä¸¤æ¬¡ä¸‹è½½ä¹‹é—´åŠ å…¥çŸ­æš‚å»¶è¿Ÿï¼Œè®©GUIæœ‰æ—¶é—´å¤„ç†æ›´æ–°
                         # root.after(10)
                     else:
                         append_log_safe(f"âš ï¸ è­¦å‘Š: APKåç§° '{apk_name}' æœªåœ¨ apk_links å­—å…¸ä¸­æ‰¾åˆ°ï¼Œè·³è¿‡ä¸‹è½½ã€‚")


            # å¯é€‰ï¼šåœ¨æ£€æŸ¥å®Œä¸€ä¸ªç‰ˆæœ¬ç±»å‹ååŠ å…¥çŸ­æš‚å»¶è¿Ÿ
            # root.after(50)


        append_log_safe("\n--- æ‰€æœ‰ç‰ˆæœ¬æ£€æŸ¥å’Œæ›´æ–°å®Œæˆ ---")
        update_progress_safe(100) # æ‰€æœ‰ä»»åŠ¡å®Œæˆåè¿›åº¦æ¡è®¾ä¸º100%

    except Exception as e:
        # æ•è·æ›´æ–°è¿‡ç¨‹ä¸­çš„æ„å¤–é”™è¯¯
        append_log_safe(f"\nâš ï¸ æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}")
        update_progress_safe(0) # å‘ç”Ÿä¸¥é‡é”™è¯¯æ—¶é‡ç½®è¿›åº¦æ¡

    finally:
        # æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œä»»åŠ¡ç»“æŸåéƒ½é‡æ–°å¯ç”¨æ‰€æœ‰æŒ‰é’®
        set_all_buttons_state(tk.NORMAL)


# --- GUI è®¾ç½® ---
root = tk.Tk()
root.title("APK æ›´æ–°è„šæœ¬")
# root.geometry("750x550") # åˆå§‹å¤§å°ç”±å†…å®¹å’Œå¸ƒå±€ç®¡ç†å™¨å†³å®šï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªæœ€å°å€¼

# ä¸» Frame ç”¨äºå¸ƒå±€æ‰€æœ‰æ§ä»¶
main_frame = ttk.Frame(root, padding="10")
# ä½¿ç”¨ grid å¸ƒå±€ä¸» Frameï¼Œå¹¶ä½¿å…¶éšçª—å£ç¼©æ”¾è€Œå¡«å……
main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

# é…ç½®æ ¹çª—å£å’Œä¸» Frame çš„ grid æƒé‡ï¼Œä½¿å®ƒä»¬å¯ä»¥éšçª—å£ç¼©æ”¾
root.columnconfigure(0, weight=1)
root.rowconfigure(0, weight=1)
main_frame.columnconfigure(0, weight=1) # è®©ç¬¬ä¸€åˆ—ï¼ˆåŒ…å«æŒ‰é’®ã€æ—¥å¿—ã€è¿›åº¦æ¡çš„åˆ—ï¼‰å¯ä¼¸ç¼©
main_frame.columnconfigure(1, weight=0) # ç¬¬äºŒåˆ—ï¼ˆä¸­é—´æŒ‰é’®ï¼‰ä¸ä¼¸ç¼©
main_frame.columnconfigure(2, weight=0) # ç¬¬ä¸‰åˆ—ï¼ˆæœ€å³æŒ‰é’®ï¼‰ä¸ä¼¸ç¼©
# main_frame.columnconfigure(3, weight=0) # æ»šåŠ¨æ¡åˆ—ä¸éœ€è¦å•ç‹¬æƒé‡ï¼Œå®ƒåœ¨gridä¸­è¢«æŒ‡å®šäº†åˆ—
main_frame.rowconfigure(2, weight=1) # è®©æ—¥å¿—æ–‡æœ¬æ¡†æ‰€åœ¨çš„ç¬¬ä¸‰è¡Œå¯ä¼¸ç¼© (ä»0å¼€å§‹è®¡æ•°)


# åˆ›å»ºæŒ‰é’®å¹¶å°†å…¶å®šä¹‰ä¸ºå…¨å±€å˜é‡ï¼Œä»¥ä¾¿ set_all_buttons_state å‡½æ•°å¯ä»¥è®¿é—®å®ƒä»¬
start_button = ttk.Button(main_frame, text="å¼€å§‹æ£€æŸ¥æ›´æ–°", command=lambda: threading.Thread(target=run_update_logic, daemon=True).start())
open_dir_button = ttk.Button(main_frame, text="æ‰“å¼€ä¸‹è½½ç›®å½•", command=open_download_directory)
kitkat_button = ttk.Button(main_frame, text="ä¸‹è½½ OKå®‰å“4ç‰ˆæœ¬", command=lambda: threading.Thread(target=_run_kitkat_download, daemon=True).start())


# å°†æŒ‰é’®æ”¾ç½®åœ¨ç¬¬ä¸€è¡Œ
start_button.grid(row=0, column=0, padx=(0, 5), pady=10, sticky=tk.W) # padx å¢åŠ å³ä¾§å¡«å……
open_dir_button.grid(row=0, column=1, padx=5, pady=10, sticky=tk.W) # padx å¢åŠ å·¦å³å¡«å……
kitkat_button.grid(row=0, column=2, padx=(5, 0), pady=10, sticky=tk.W) # padx å¢åŠ å·¦ä¾§å¡«å……


# æ—¥å¿—æ ‡ç­¾
log_label = ttk.Label(main_frame, text="æ—¥å¿—è¾“å‡º:")
# å°†æ ‡ç­¾æ”¾ç½®åœ¨ç¬¬äºŒè¡Œç¬¬ä¸€åˆ—
log_label.grid(row=1, column=0, sticky=tk.W)

# æ—¥å¿—æ–‡æœ¬æ¡†
log_text = tk.Text(main_frame, height=15, width=70, wrap=tk.WORD) # wrap=tk.WORD æŒ‰å•è¯æ¢è¡Œ
# å°†æ–‡æœ¬æ¡†æ”¾ç½®åœ¨ç¬¬ä¸‰è¡Œï¼Œè·¨è¶ŠæŒ‰é’®åˆ—ï¼Œå¹¶ä½¿å…¶éšå•å…ƒæ ¼ä¼¸ç¼©
log_text.grid(row=2, column=0, columnspan=3, padx=5, pady=5, sticky=(tk.W, tk.E, tk.N, tk.S))

# ä¸ºæ—¥å¿—æ–‡æœ¬æ¡†æ·»åŠ å‚ç›´æ»šåŠ¨æ¡
# æ»šåŠ¨æ¡æ”¾ç½®åœ¨ç¬¬ä¸‰è¡Œæœ€å³ä¾§çš„åˆ—
log_scrollbar = ttk.Scrollbar(main_frame, command=log_text.yview)
log_scrollbar.grid(row=2, column=3, sticky=(tk.N, tk.S)) # æ”¾åœ¨ç¬¬3åˆ—
# å°†æ»šåŠ¨æ¡å…³è”åˆ°æ–‡æœ¬æ¡†
log_text['yscrollcommand'] = log_scrollbar.set

# è¿›åº¦æ ‡ç­¾
progress_label = ttk.Label(main_frame, text="å½“å‰ä»»åŠ¡è¿›åº¦:")
# å°†æ ‡ç­¾æ”¾ç½®åœ¨ç¬¬å››è¡Œç¬¬ä¸€åˆ—
progress_label.grid(row=3, column=0, sticky=tk.W)

# ä¸‹è½½è¿›åº¦æ¡
progress_bar = ttk.Progressbar(main_frame, orient="horizontal", mode="determinate") # mode="determinate" è¡¨ç¤ºå·²çŸ¥æ€»è¿›åº¦çš„è¿›åº¦æ¡
# å°†è¿›åº¦æ¡æ”¾ç½®åœ¨ç¬¬äº”è¡Œï¼Œè·¨è¶Šæ‰€æœ‰æŒ‰é’®åˆ—ï¼Œå¹¶ä½¿å…¶éšå•å…ƒæ ¼æ°´å¹³ä¼¸ç¼©
progress_bar.grid(row=4, column=0, columnspan=3, padx=5, pady=5, sticky=(tk.W, tk.E))


# åˆå§‹æ¶ˆæ¯åœ¨æ—¥å¿—ä¸­
append_log_safe("è¯·ç‚¹å‡»æŒ‰é’®å¯åŠ¨ç¨‹åºã€‚")

# å¯åŠ¨ GUI äº‹ä»¶å¾ªç¯
root.mainloop()
