import os
import sys
import threading
import requests
import webbrowser
import tkinter as tk
from tkinter import ttk, messagebox

# --- è·¯å¾„é…ç½® ---
if getattr(sys, 'frozen', False):
    BASE_DIR = os.path.dirname(sys.executable)
else:
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))

download_dir = os.path.join(BASE_DIR, "Download")
os.makedirs(download_dir, exist_ok=True)

USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
REPO = "hc990275/apkdown" # æ‚¨çš„ä»“åº“

# --- å·¥å…·è‡ªèº«ç‰ˆæœ¬å· (è‡ªåŠ¨æ›¿æ¢) ---
TOOL_VERSION = "v2025.12.28_1151" 

# --- åº”ç”¨ç‰ˆæœ¬å· (è‡ªåŠ¨æ›¿æ¢) ---
OK_VER_MOBILE = "OK-3.5.7"
OK_VER_TV = "OK-3.5.7"
OK_VER_PRO = "OK-3.8.8-pro"
OK_VER_4X = "OK-2.5.0"
FM_VER_MOBILE = "FM-5.0.4"
FM_VER_TV = "FM-5.0.4"

# --- APK ä¸‹è½½é“¾æ¥æ˜ å°„ ---
apk_links = {
    "OKç‰ˆæ‰‹æœº_32": "lystv/fmapp/54dbf376f4fca72e12061e13fb689db87f99235b/apk/release/mobile-armeabi_v7a.apk",
    "OKç‰ˆç”µè§†_32": "lystv/fmapp/54dbf376f4fca72e12061e13fb689db87f99235b/apk/release/leanback-armeabi_v7a.apk",
    "OKå®‰å“4ç‰ˆæœ¬_APK": "lystv/fmapp/93fd99c68e7bddc4b903a2fe12fdbd372630610b/apk/kitkat/leanback.apk",
    "OKç‰ˆPro_æ‰‹æœºPro": "lystv/fmapp/08b161ad2417393aca9141ad63956c917e5fbd65/apk/pro/mobile-pro.apk",
    "OKç‰ˆPro_ç”µè§†Pro": "lystv/fmapp/08b161ad2417393aca9141ad63956c917e5fbd65/apk/pro/leanback-pro.apk",
    "èœœèœ‚ç‰ˆæ‰‹æœº_PY32": "fongmi/release/38ecab09fba63ecf10ef5eb92951b9554bb9f803/apk/mobile-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆæ‰‹æœº_JAVA32": "fongmi/release/38ecab09fba63ecf10ef5eb92951b9554bb9f803/apk/mobile-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_PY32": "fongmi/release/38ecab09fba63ecf10ef5eb92951b9554bb9f803/apk/leanback-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_JAVA32": "fongmi/release/38ecab09fba63ecf10ef5eb92951b9554bb9f803/apk/leanback-armeabi_v7a.apk",
}

# --- GUI è¾…åŠ© ---
def append_log_safe(message):
    root.after(0, _append_log_gui, message)
def _append_log_gui(message):
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)
def update_progress_safe(value):
    root.after(0, lambda: progress_bar.config(value=value))
def set_all_buttons_state(state):
    root.after(0, lambda: [btn.config(state=state) for btn in [start_button, open_dir_button, kitkat_button]])

def open_download_directory():
    try:
        os.startfile(os.path.realpath(download_dir))
    except Exception as e:
        append_log_safe(f"âŒ æ— æ³•æ‰“å¼€ç›®å½•: {e}")

# --- è‡ªæˆ‘æ›´æ–°é€»è¾‘ ---
def check_tool_update():
    try:
        append_log_safe(f"ğŸ“¡ æ£€æŸ¥å·¥å…·æ›´æ–° (å½“å‰: {TOOL_VERSION})...")
        api_url = f"https://api.github.com/repos/{REPO}/releases/latest"
        resp = requests.get(api_url, headers={'User-Agent': USER_AGENT}, timeout=5)
        resp.raise_for_status()
        data = resp.json()
        
        latest_tag = data.get("tag_name", "")
        if latest_tag and latest_tag != TOOL_VERSION:
            append_log_safe(f"ğŸš€ å‘ç°æ–°ç‰ˆæœ¬å·¥å…·: {latest_tag}")
            
            # å¯»æ‰¾ EXE ä¸‹è½½é“¾æ¥
            exe_url = ""
            for asset in data.get("assets", []):
                if asset.get("name", "").endswith(".exe"):
                    exe_url = asset.get("browser_download_url")
                    break
            
            # å¼¹çª—æç¤º
            msg = f"å‘ç°æ–°ç‰ˆæœ¬ {latest_tag}ï¼\n\nå½“å‰ç‰ˆæœ¬: {TOOL_VERSION}\n\næ˜¯å¦ç«‹å³å‰å¾€ä¸‹è½½æ–°ç‰ˆ EXEï¼Ÿ"
            if exe_url and messagebox.askyesno("å‘ç°æ›´æ–°", msg):
                webbrowser.open(exe_url)
        else:
            append_log_safe(f"âœ… å·¥å…·å·²æ˜¯æœ€æ–°ç‰ˆ")
    except Exception as e:
        append_log_safe(f"âš ï¸ æ£€æŸ¥å·¥å…·æ›´æ–°å¤±è´¥: {e}")

# --- æ ¸å¿ƒé€»è¾‘ ---
def download_apk(apk_name, desc=""):
    rel_path = apk_links.get(apk_name)
    if not rel_path: return
    
    url = f"https://raw.githubusercontent.com/{rel_path}"
    fname = apk_name.replace("_APK", "") + ".apk"
    fpath = os.path.join(download_dir, fname)
    
    append_log_safe(f"â¬‡ï¸ ä¸‹è½½ {desc}: {fname}")
    try:
        r = requests.get(url, stream=True, headers={'User-Agent': USER_AGENT}, timeout=60)
        total = int(r.headers.get('content-length', 0))
        done = 0
        with open(fpath, 'wb') as f:
            for chunk in r.iter_content(8192):
                f.write(chunk)
                done += len(chunk)
                if total: update_progress_safe(int(done/total*100))
        append_log_safe(f"âœ… å®Œæˆ")
    except Exception as e:
        append_log_safe(f"âŒ å¤±è´¥: {e}")

def run_download_all():
    set_all_buttons_state(tk.DISABLED)
    update_progress_safe(0)
    append_log_safe("ğŸš€ å¼€å§‹æ‰¹é‡ä¸‹è½½ä»»åŠ¡...")
    
    try:
        download_apk("OKç‰ˆPro_æ‰‹æœºPro", f"OKProæ‰‹æœº({OK_VER_PRO})")
        download_apk("OKç‰ˆPro_ç”µè§†Pro", f"OKProç”µè§†({OK_VER_PRO})")
        download_apk("OKç‰ˆæ‰‹æœº_32", f"OKæ‰‹æœº({OK_VER_MOBILE})")
        download_apk("OKç‰ˆç”µè§†_32", f"OKç”µè§†({OK_VER_TV})")
        download_apk("èœœèœ‚ç‰ˆæ‰‹æœº_PY32", f"èœœèœ‚æ‰‹æœº({FM_VER_MOBILE})")
        download_apk("èœœèœ‚ç‰ˆç”µè§†_PY32", f"èœœèœ‚ç”µè§†({FM_VER_TV})")
        
        append_log_safe("\nğŸ æ‰€æœ‰ä¸‹è½½ä»»åŠ¡å®Œæˆï¼")
        update_progress_safe(100)
    finally:
        set_all_buttons_state(tk.NORMAL)

def _run_kitkat():
    set_all_buttons_state(tk.DISABLED)
    download_apk("OKå®‰å“4ç‰ˆæœ¬_APK", f"OKå®‰å“4.x({OK_VER_4X})")
    set_all_buttons_state(tk.NORMAL)

# --- GUI ---
root = tk.Tk()
root.title(f"å½±è§†æ›´æ–°å·¥å…· {TOOL_VERSION}")
root.geometry("600x520")

# ä¿¡æ¯é¢æ¿
info_frame = ttk.LabelFrame(root, text="å½“å‰å†…ç½®ç‰ˆæœ¬ä¿¡æ¯", padding=10)
info_frame.pack(fill=tk.X, padx=10, pady=5)
info_label = ttk.Label(info_frame, text=f"OKç‰ˆ: {OK_VER_MOBILE} | Pro: {OK_VER_PRO}\nèœœèœ‚ç‰ˆ: {FM_VER_MOBILE}", justify=tk.CENTER)
info_label.pack()

# æŒ‰é’®åŒºåŸŸ
btn_frame = ttk.Frame(root, padding=10)
btn_frame.pack(fill=tk.X)

start_button = ttk.Button(btn_frame, text="ğŸš€ ä¸€é”®ä¸‹è½½æ‰€æœ‰æœ€æ–°ç‰ˆ", command=lambda: threading.Thread(target=run_download_all, daemon=True).start())
start_button.pack(fill=tk.X, pady=5)

open_dir_button = ttk.Button(btn_frame, text="ğŸ“‚ æ‰“å¼€ä¸‹è½½æ–‡ä»¶å¤¹", command=open_download_directory)
open_dir_button.pack(fill=tk.X, pady=5)

kitkat_button = ttk.Button(btn_frame, text="â¬‡ï¸ ä¸‹è½½ OKå®‰å“4.x (æ—§æœºä¸“ç”¨)", command=lambda: threading.Thread(target=_run_kitkat, daemon=True).start())
kitkat_button.pack(fill=tk.X, pady=5)

# æ—¥å¿—
log_text = tk.Text(root, height=12)
log_text.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)

progress_bar = ttk.Progressbar(root, orient="horizontal", mode="determinate")
progress_bar.pack(fill=tk.X, padx=10, pady=10)

append_log_safe(f"ç¨‹åºå¯åŠ¨ï¼Œç‰ˆæœ¬: {TOOL_VERSION}")

# å¯åŠ¨åè‡ªåŠ¨æ£€æŸ¥è‡ªèº«æ›´æ–°
root.after(1000, lambda: threading.Thread(target=check_tool_update, daemon=True).start())

root.mainloop()
