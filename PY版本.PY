import os
import sys
import threading
import shutil
import json
import requests
import tkinter as tk
from tkinter import ttk

# --- è·¯å¾„é…ç½® (è‡ªåŠ¨è·å–å½“å‰ç›®å½•ï¼Œå…¼å®¹ EXE å’Œ è„šæœ¬è¿è¡Œ) ---
if getattr(sys, 'frozen', False):
    BASE_DIR = os.path.dirname(sys.executable)
else:
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))

download_dir = os.path.join(BASE_DIR, "Download")
version_folder = os.path.join(download_dir, "VersionInfo")
os.makedirs(download_dir, exist_ok=True)
os.makedirs(version_folder, exist_ok=True)

USER_AGENT = "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Mobile Safari/537.36 EdgA/121.0.0.0"

# --- ç‰ˆæœ¬ä¿¡æ¯ URL (å°†è¢«è‡ªåŠ¨åŒ–è„šæœ¬æ›¿æ¢) ---
urls = {
    "OKç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/release/mobile.json",
    "OKç‰ˆç”µè§†": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/release/leanback.json",
    "OKç‰ˆPro": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/pro/v.txt",
    "èœœèœ‚ç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/mobile.json",
    "èœœèœ‚ç‰ˆç”µè§†": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/leanback.json"
}

# --- APK ä¸‹è½½é“¾æ¥æ˜ å°„ (ä»…ä¿ç•™32ä½/Pro/4.x) ---
apk_links = {
    "OKç‰ˆæ‰‹æœº_32": "lystv/fmapp/ok/apk/release/mobile-armeabi_v7a.apk",
    "OKç‰ˆç”µè§†_32": "lystv/fmapp/ok/apk/release/leanback-armeabi_v7a.apk",
    "OKå®‰å“4ç‰ˆæœ¬_APK": "lystv/fmapp/ok/apk/kitkat/leanback.apk",
    "OKç‰ˆPro_æ‰‹æœºPro": "lystv/fmapp/ok/apk/pro/mobile-pro.apk",
    "OKç‰ˆPro_ç”µè§†Pro": "lystv/fmapp/ok/apk/pro/leanback-pro.apk",
    # èœœèœ‚ç‰ˆ (é€šç”¨32ä½)
    "èœœèœ‚ç‰ˆæ‰‹æœº_PY32": "FongMi/Release/fongmi/apk/mobile-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆæ‰‹æœº_JAVA32": "FongMi/Release/fongmi/apk/mobile-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_PY32": "FongMi/Release/fongmi/apk/leanback-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_JAVA32": "FongMi/Release/fongmi/apk/leanback-armeabi_v7a.apk",
}

# --- GUI è¾…åŠ© ---
def append_log_safe(message):
    root.after(0, _append_log_gui, message)
def _append_log_gui(message):
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)
def update_progress_safe(value):
    root.after(0, lambda: progress_bar.config(value=value))
def set_all_buttons_state(state):
    root.after(0, lambda: [btn.config(state=state) for btn in [start_button, open_dir_button, kitkat_button]])

def open_download_directory():
    target_dir = os.path.realpath(download_dir)
    append_log_safe(f"æ‰“å¼€ç›®å½•: {target_dir}")
    try:
        os.startfile(target_dir)
    except Exception as e:
        append_log_safe(f"âŒ æ— æ³•æ‰“å¼€ç›®å½•: {e}")

# --- æ ¸å¿ƒé€»è¾‘ ---
def check_json_update(name):
    url = urls.get(name)
    if not url: return False
    
    old_json = os.path.join(version_folder, f"{name}.json")
    new_json = os.path.join(version_folder, f"{name}ä¸´æ—¶.json")
    
    try:
        append_log_safe(f"ğŸ” æ­£åœ¨æ£€æŸ¥: {name} ...")
        resp = requests.get(url, headers={'User-Agent': USER_AGENT}, timeout=15)
        resp.raise_for_status()
        with open(new_json, 'wb') as f: f.write(resp.content)
    except Exception as e:
        append_log_safe(f"âš ï¸ æ£€æŸ¥å¤±è´¥ ({name}): {e}")
        return False

    old_ver = ""
    new_ver = ""
    try:
        if name == "OKç‰ˆPro":
            if os.path.exists(old_json): old_ver = open(old_json, "r", encoding='utf-8').read().strip()
            new_ver = open(new_json, "r", encoding='utf-8').read().strip()
        else:
            if os.path.exists(old_json): old_ver = json.load(open(old_json, 'r', encoding='utf-8')).get("name", "")
            new_ver = json.load(open(new_json, 'r', encoding='utf-8')).get("name", "")
    except: pass

    updated = False
    if new_ver and new_ver != old_ver:
        append_log_safe(f"ğŸš€ {name} å‘ç°æ–°ç‰ˆæœ¬: {new_ver} (æ—§: {old_ver})")
        shutil.copy(new_json, old_json)
        updated = True
    else:
        append_log_safe(f"âœ… {name} å·²æ˜¯æœ€æ–° ({new_ver})")

    if os.path.exists(new_json): os.remove(new_json)
    return updated

def download_apk(apk_name):
    rel_path = apk_links.get(apk_name)
    if not rel_path: return
    
    url = f"https://raw.githubusercontent.com/{rel_path}"
    fname = apk_name.replace("_APK", "") + ".apk"
    fpath = os.path.join(download_dir, fname)
    
    append_log_safe(f"â¬‡ï¸ æ­£åœ¨ä¸‹è½½: {fname}")
    try:
        r = requests.get(url, stream=True, headers={'User-Agent': USER_AGENT}, timeout=60)
        total = int(r.headers.get('content-length', 0))
        done = 0
        with open(fpath, 'wb') as f:
            for chunk in r.iter_content(8192):
                f.write(chunk)
                done += len(chunk)
                if total: update_progress_safe(int(done/total*100))
        append_log_safe(f"âœ… ä¸‹è½½å®Œæˆ: {fname}")
    except Exception as e:
        append_log_safe(f"âŒ ä¸‹è½½å‡ºé”™: {e}")

def run_update_logic():
    set_all_buttons_state(tk.DISABLED)
    update_progress_safe(0)
    
    try:
        if check_json_update("OKç‰ˆPro"):
            download_apk("OKç‰ˆPro_æ‰‹æœºPro")
            download_apk("OKç‰ˆPro_ç”µè§†Pro")
        
        if check_json_update("OKç‰ˆæ‰‹æœº"):
            download_apk("OKç‰ˆæ‰‹æœº_32")

        if check_json_update("OKç‰ˆç”µè§†"):
            download_apk("OKç‰ˆç”µè§†_32")

        if check_json_update("èœœèœ‚ç‰ˆæ‰‹æœº"):
            download_apk("èœœèœ‚ç‰ˆæ‰‹æœº_PY32") # ä¸‹è½½32ä½
            download_apk("èœœèœ‚ç‰ˆæ‰‹æœº_JAVA32") # ä¿æŒå…¼å®¹æ€§

        if check_json_update("èœœèœ‚ç‰ˆç”µè§†"):
            download_apk("èœœèœ‚ç‰ˆç”µè§†_PY32") # ä¸‹è½½32ä½
            download_apk("èœœèœ‚ç‰ˆç”µè§†_JAVA32") # ä¿æŒå…¼å®¹æ€§

        append_log_safe("\nğŸ æ‰€æœ‰æ“ä½œæ‰§è¡Œå®Œæ¯•ï¼")
        update_progress_safe(100)
    except Exception as e:
        append_log_safe(f"âš ï¸ å…¨å±€é”™è¯¯: {e}")
    finally:
        set_all_buttons_state(tk.NORMAL)

def _run_kitkat():
    set_all_buttons_state(tk.DISABLED)
    download_apk("OKå®‰å“4ç‰ˆæœ¬_APK")
    set_all_buttons_state(tk.NORMAL)

# --- GUI ---
root = tk.Tk()
root.title("å½±è§†æ›´æ–°å·¥å…· (ç²¾ç®€ç‰ˆ)")
root.geometry("600x480")

frame = ttk.Frame(root, padding=10)
frame.pack(fill=tk.BOTH, expand=True)

start_button = ttk.Button(frame, text="ğŸš€ ä¸€é”®æ£€æŸ¥æ›´æ–° (32ä½/Pro)", command=lambda: threading.Thread(target=run_update_logic, daemon=True).start())
start_button.pack(fill=tk.X, pady=5)

open_dir_button = ttk.Button(frame, text="ğŸ“‚ æ‰“å¼€ä¸‹è½½æ–‡ä»¶å¤¹", command=open_download_directory)
open_dir_button.pack(fill=tk.X, pady=5)

kitkat_button = ttk.Button(frame, text="â¬‡ï¸ ä¸‹è½½ OKå®‰å“4.x (æ—§æœºä¸“ç”¨)", command=lambda: threading.Thread(target=_run_kitkat, daemon=True).start())
kitkat_button.pack(fill=tk.X, pady=5)

log_text = tk.Text(frame, height=15)
log_text.pack(fill=tk.BOTH, expand=True, pady=5)

progress_bar = ttk.Progressbar(frame, orient="horizontal", mode="determinate")
progress_bar.pack(fill=tk.X, pady=5)

append_log_safe("æ¬¢è¿ä½¿ç”¨ï¼ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ›´æ–°ã€‚")
root.mainloop()
