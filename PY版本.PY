import os
import sys
import threading
import shutil
import json
import requests
import tkinter as tk
from tkinter import ttk

# --- è·¯å¾„é…ç½® (è‡ªåŠ¨è·å–å½“å‰ç›®å½•ï¼Œå…¼å®¹ EXE å’Œ è„šæœ¬è¿è¡Œ) ---
if getattr(sys, 'frozen', False):
    # å¦‚æœæ˜¯æ‰“åŒ…åçš„ exeï¼Œä½¿ç”¨ exe æ‰€åœ¨ç›®å½•
    BASE_DIR = os.path.dirname(sys.executable)
else:
    # å¦‚æœæ˜¯è„šæœ¬è¿è¡Œï¼Œä½¿ç”¨è„šæœ¬æ‰€åœ¨ç›®å½•
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))

# è®¾ç½®ä¸‹è½½ç›®å½•ä¸ºå½“å‰ç›®å½•ä¸‹çš„ "Download" æ–‡ä»¶å¤¹
download_dir = os.path.join(BASE_DIR, "Download")
version_folder = os.path.join(download_dir, "VersionInfo")

# ç¡®ä¿ç›®å½•å­˜åœ¨
os.makedirs(download_dir, exist_ok=True)
os.makedirs(version_folder, exist_ok=True)

# è®¾ç½® GitHub ç”¨æˆ·ä»£ç†
USER_AGENT = "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Mobile Safari/537.36 EdgA/121.0.0.0"

# --- ç‰ˆæœ¬ä¿¡æ¯ URL (å°†è¢«è‡ªåŠ¨åŒ–è„šæœ¬æ›¿æ¢) ---
urls = {
    "OKç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/release/mobile.json",
    "OKç‰ˆç”µè§†": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/release/leanback.json",
    "OKç‰ˆPro": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/pro/v.txt",
    "èœœèœ‚ç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/mobile.json",
    "èœœèœ‚ç‰ˆç”µè§†": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/leanback.json"
}

# --- APK ä¸‹è½½é“¾æ¥æ˜ å°„ (å°†è¢«è‡ªåŠ¨åŒ–è„šæœ¬æ›¿æ¢ï¼Œä»…ä¿ç•™æ¨èç‰ˆæœ¬) ---
apk_links = {
    # OKç‰ˆ (ä»…ä¿ç•™ 32ä½)
    "OKç‰ˆæ‰‹æœº_32": "lystv/fmapp/ok/apk/release/mobile-armeabi_v7a.apk",
    "OKç‰ˆç”µè§†_32": "lystv/fmapp/ok/apk/release/leanback-armeabi_v7a.apk",
    
    # OK 4.x
    "OKå®‰å“4ç‰ˆæœ¬_APK": "lystv/fmapp/ok/apk/kitkat/leanback.apk",

    # OK Pro (ä»…ä¿ç•™æ ‡å‡†ç‰ˆ)
    "OKç‰ˆPro_æ‰‹æœºPro": "lystv/fmapp/ok/apk/pro/mobile-pro.apk",
    "OKç‰ˆPro_ç”µè§†Pro": "lystv/fmapp/ok/apk/pro/leanback-pro.apk",

    # èœœèœ‚ç‰ˆ (ä»…ä¿ç•™ 32ä½ï¼Œç»Ÿä¸€æ˜ å°„)
    "èœœèœ‚ç‰ˆæ‰‹æœº_PY32": "FongMi/Release/fongmi/apk/mobile-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆæ‰‹æœº_JAVA32": "FongMi/Release/fongmi/apk/mobile-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_PY32": "FongMi/Release/fongmi/apk/leanback-armeabi_v7a.apk",
    "èœœèœ‚ç‰ˆç”µè§†_JAVA32": "FongMi/Release/fongmi/apk/leanback-armeabi_v7a.apk",
}

# --- GUI è¾…åŠ©å‡½æ•° ---
def append_log_safe(message):
    root.after(0, _append_log_gui, message)

def _append_log_gui(message):
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)

def update_progress_safe(value):
    root.after(0, _update_progress_gui, value)

def _update_progress_gui(value):
    progress_bar['value'] = value

def set_all_buttons_state(state):
    root.after(0, _set_all_buttons_gui, state)

def _set_all_buttons_gui(state):
    if 'start_button' in globals() and start_button.winfo_exists():
         start_button.config(state=state)
    if 'open_dir_button' in globals() and open_dir_button.winfo_exists():
         open_dir_button.config(state=state)
    if 'kitkat_button' in globals() and kitkat_button.winfo_exists():
         kitkat_button.config(state=state)

# --- æ“ä½œç³»ç»Ÿäº¤äº’ ---
def open_download_directory():
    target_dir = os.path.realpath(download_dir)
    append_log_safe(f"æ‰“å¼€ç›®å½•: {target_dir}")
    try:
        os.startfile(target_dir) # Windows Only
    except Exception as e:
        append_log_safe(f"âŒ æ‰“å¼€ç›®å½•å¤±è´¥: {e}")

# --- æ ¸å¿ƒé€»è¾‘ (åå°çº¿ç¨‹) ---
def check_json_update(name):
    url = urls.get(name)
    if not url: return False
    
    old_json_file = os.path.join(version_folder, f"{name}.json")
    new_json_file = os.path.join(version_folder, f"{name}ä¸´æ—¶.json")
    updated = False

    append_log_safe(f"æ­£åœ¨æ£€æŸ¥ {name} ...")

    try:
        response = requests.get(url, headers={'User-Agent': USER_AGENT}, timeout=15)
        response.raise_for_status()
        with open(new_json_file, 'wb') as f:
            f.write(response.content)
    except Exception as e:
        append_log_safe(f"âš ï¸ ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥: {e}")
        return False

    old_version = ""
    new_version = ""

    # è§£æç‰ˆæœ¬å·
    try:
        if name == "OKç‰ˆPro": # çº¯æ–‡æœ¬
            if os.path.exists(old_json_file):
                with open(old_json_file, "r", encoding='utf-8') as f: old_version = f.readline().strip()
            with open(new_json_file, "r", encoding='utf-8') as f: new_version = f.readline().strip()
        else: # JSON
            if os.path.exists(old_json_file):
                with open(old_json_file, 'r', encoding='utf-8') as f: old_version = json.load(f).get("name", "")
            with open(new_json_file, 'r', encoding='utf-8') as f: new_version = json.load(f).get("name", "")
    except Exception:
        pass

    append_log_safe(f"{name}: {old_version} -> {new_version}")

    if new_version and new_version != old_version:
        append_log_safe(f"ğŸš€ å‘ç° {name} æ–°ç‰ˆæœ¬ï¼Œå‡†å¤‡æ›´æ–°...")
        shutil.copy(new_json_file, old_json_file)
        updated = True
    else:
        updated = False

    if os.path.exists(new_json_file): os.remove(new_json_file)
    return updated

def download_apk(apk_name):
    update_progress_safe(0)
    relative_path = apk_links.get(apk_name)
    if not relative_path:
        append_log_safe(f"âš ï¸ æœªæ‰¾åˆ° {apk_name} çš„ä¸‹è½½é“¾æ¥")
        return

    apk_url = f"https://raw.githubusercontent.com/{relative_path}"
    clean_name = apk_name.replace("_APK", "")
    apk_path = os.path.join(download_dir, f"{clean_name}.apk")

    append_log_safe(f"ğŸ“¥ ä¸‹è½½: {clean_name}.apk")
    
    try:
        response = requests.get(apk_url, stream=True, headers={'User-Agent': USER_AGENT}, timeout=60)
        response.raise_for_status()
        total_size = int(response.headers.get('content-length', 0))
        downloaded = 0

        with open(apk_path, 'wb') as f:
            for data in response.iter_content(chunk_size=8192):
                f.write(data)
                downloaded += len(data)
                if total_size > 0:
                    update_progress_safe(int((downloaded / total_size) * 100))

        append_log_safe(f"âœ… å®Œæˆ: {clean_name}.apk")
        update_progress_safe(100)
    except Exception as e:
        append_log_safe(f"âŒ ä¸‹è½½å¤±è´¥: {e}")
        update_progress_safe(0)

def _run_kitkat_download():
    set_all_buttons_state(tk.DISABLED)
    try:
        download_apk("OKå®‰å“4ç‰ˆæœ¬_APK")
    finally:
        set_all_buttons_state(tk.NORMAL)

def run_update_logic():
    set_all_buttons_state(tk.DISABLED)
    update_progress_safe(0)
    try:
        # 1. æ£€æŸ¥ OKç‰ˆ Pro
        if check_json_update("OKç‰ˆPro"):
            download_apk("OKç‰ˆPro_æ‰‹æœºPro")
            download_apk("OKç‰ˆPro_ç”µè§†Pro")
        
        # 2. æ£€æŸ¥ OKç‰ˆ æ‰‹æœº
        if check_json_update("OKç‰ˆæ‰‹æœº"):
            download_apk("OKç‰ˆæ‰‹æœº_32")

        # 3. æ£€æŸ¥ OKç‰ˆ ç”µè§†
        if check_json_update("OKç‰ˆç”µè§†"):
            download_apk("OKç‰ˆç”µè§†_32")

        # 4. æ£€æŸ¥ èœœèœ‚ç‰ˆ æ‰‹æœº
        if check_json_update("èœœèœ‚ç‰ˆæ‰‹æœº"):
            download_apk("èœœèœ‚ç‰ˆæ‰‹æœº_PY32") # é»˜è®¤ä¸‹è½½ PY32 (é€šç”¨)
            download_apk("èœœèœ‚ç‰ˆæ‰‹æœº_JAVA32")

        # 5. æ£€æŸ¥ èœœèœ‚ç‰ˆ ç”µè§†
        if check_json_update("èœœèœ‚ç‰ˆç”µè§†"):
            download_apk("èœœèœ‚ç‰ˆç”µè§†_PY32") # é»˜è®¤ä¸‹è½½ PY32 (é€šç”¨)
            download_apk("èœœèœ‚ç‰ˆç”µè§†_JAVA32")

        append_log_safe("\nğŸ æ‰€æœ‰æ£€æŸ¥å®Œæˆ")
        update_progress_safe(100)
    except Exception as e:
        append_log_safe(f"âš ï¸ å‘ç”Ÿé”™è¯¯: {e}")
    finally:
        set_all_buttons_state(tk.NORMAL)

# --- GUI å¸ƒå±€ ---
root = tk.Tk()
root.title("å½±è§†æ›´æ–°å·¥å…· (Windowsç‰ˆ)")
root.geometry("600x450")

main_frame = ttk.Frame(root, padding="10")
main_frame.pack(fill=tk.BOTH, expand=True)

start_button = ttk.Button(main_frame, text="ğŸš€ ä¸€é”®æ£€æŸ¥æ›´æ–°", command=lambda: threading.Thread(target=run_update_logic, daemon=True).start())
start_button.pack(fill=tk.X, pady=5)

open_dir_button = ttk.Button(main_frame, text="ğŸ“‚ æ‰“å¼€ä¸‹è½½ç›®å½•", command=open_download_directory)
open_dir_button.pack(fill=tk.X, pady=5)

kitkat_button = ttk.Button(main_frame, text="â¬‡ï¸ ä¸‹è½½ OKå®‰å“4.xä¸“ç”¨ç‰ˆ", command=lambda: threading.Thread(target=_run_kitkat_download, daemon=True).start())
kitkat_button.pack(fill=tk.X, pady=5)

log_text = tk.Text(main_frame, height=12)
log_text.pack(fill=tk.BOTH, expand=True, pady=5)

progress_bar = ttk.Progressbar(main_frame, orient="horizontal", mode="determinate")
progress_bar.pack(fill=tk.X, pady=5)

append_log_safe("ç¨‹åºå°±ç»ªï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å·¥ä½œã€‚")
root.mainloop()
